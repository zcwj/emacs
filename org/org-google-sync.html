<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Google Calendar Synchronization</title>
<!-- 2014-05-02 五 10:38 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Arun Persaud" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Google Calendar Synchronization</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">Overview</a></li>
<li><a href="#sec-2">From Google Calendar into org using .ics files</a></li>
<li><a href="#sec-3">From org to Google Calendar</a></li>
<li><a href="#sec-4">Other methods of syncing</a>
<ul>
<li><a href="#sec-4-1">org-caldav</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Overview</h2>
<div class="outline-text-2" id="text-1">
<p>
To get a real synchronization between org-mode and Google Calendar
you need to sync two ways. We cover one way of handling the
synchronization in the next two sections and also mention some other
ways of synchronization at the end.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">From Google Calendar into org using .ics files</h2>
<div class="outline-text-2" id="text-2">
<p>
Google Calendar offers access to each calendar via a hidden/secret
url. That is, a url that only you know about and is very hard to
guess for other people. You can use this to download your calendar
in an iCalendar (.ics) format, which we then can rewrite into
something usable for org-mode. For this conversion there luckily
already exists a script written by Eric S. Fraga<sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup>.
</p>

<p>
Youcan get the latest version here: ical2org.awk
</p>

<p>
With this you can test your Google Calendar to org-mode
synchronization by following these steps:
</p>

<ol class="org-ol">
<li>Download the above script and save it as 'ical2org'.
Make sure that the script is in your PATH and don't forget to set
the executable flag (chmod u+x ical2org). You can also customize the
script a bit by changing the variables in the config section of the script.
</li>
<li>Find your private URL for your calendar
<ul class="org-ul">
<li>Log into Google Calendar
</li>
<li>Goto Settings
</li>
<li>Click on the calendar you want to export to org-mode
</li>
<li>At the bottom of the page find the 'private address' section and your ical link
Use the 'reset private urls' if you need to, that is if you don't
see a unique url.
</li>
</ul>
</li>
<li>Download the url
This can be done for example using 'wget &lt;url&gt;'
</li>
<li>Transform into org-file
Use the downloaded script via 'ical2org &lt; icsfile &gt; orgfile'. Where
icsfile is the path to the file you downloaded from Google and
orgfile is the org-mode file you want to create.
</li>
<li>Add the orgfile to your agenda and test
</li>
</ol>

<p>
If this all works you can automate the task via cron. Create a script
such as the following that will automatically download and convert
your calendar. Make sure that this file is only readable by you (chmod
700 &lt;file&gt;), since it will contain the url to your Google calendar.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">!/bin/</span><span style="color: #00ffff;">bash</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">customize these</span>
<span style="color: #eedd82;">WGET</span>=&lt;path to wget&gt;
<span style="color: #eedd82;">ICS2ORG</span>=&lt;path to ical2org&gt;
<span style="color: #eedd82;">ICSFILE</span>=&lt;path for icsfile&gt;
<span style="color: #eedd82;">ORGFILE</span>=&lt;path to orgfile&gt;
<span style="color: #eedd82;">URL</span>=&lt;url to your private Google calendar&gt;

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">no customization needed below</span>

$<span style="color: #eedd82;">WGET</span> -O $<span style="color: #eedd82;">ICSFILE</span> $<span style="color: #eedd82;">URL</span>
$<span style="color: #eedd82;">ICS2ORG</span> &lt; $<span style="color: #eedd82;">ICSFILE</span> &gt; $<span style="color: #eedd82;">ORGFILE</span>
</pre>
</div>

<p>
automate this via cron by adding something like the following to your
crontab:
</p>

<pre class="example">
5,20,35,50 * * * * &lt;path to above script&gt; &amp;&gt; /dev/null #sync my org files
</pre>

<p>
This will sync every 15 minutes starting at 5 minutes past the hour.
</p>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">From org to Google Calendar</h2>
<div class="outline-text-2" id="text-3">
<p>
There are at least two possible paths to get the information into Google:
</p>

<ol class="org-ol">
<li>export from org mode to .ics; upload .ics to a public web server
giving it a hidden/secret name; tell Google to import this .ics
file
</li>
<li>use googlecl to import event when you create them into Google
calendar (update entries won't be reflected in Google). See <sup><a id="fnr.2" name="fnr.2" class="footref" href="#fn.2">2</a></sup>
</li>
</ol>

<p>
The first one has the disadvantage that the item won't show up in
your "main" calendar and therefore you can't easily share them with
others. Nevertheless, this route is relatively easy and therefore
we'll discuss it below.  The second option (as described in the link)
should work well, if you don't need to change things.
</p>

<p>
Also keep in mind that your mileage will vary, since everything
described on this page works for some people, but perhaps not for
you&#x2026; if this is the case, feel free to ask on the org-email list
and perhaps we can add missing features.
</p>

<p>
Back to the topic. To implement 1., we need org to export an .ics
file, which can be achieved using the function:
org-export-icalendar-combine-agenda-files.
This will export all entries in you agenda. If you only want to
export certain ones, you can set up a filter. For this we will
define a filter function and then tell Emacs to use this filter.
The filter shown here, will exclude items with a category "google"
(for example from the ical2org script) and "private" and also only
export entries that have a date and a time range set (that is, a
start and a end time stamp). You can modify the function though to
do anything you want!
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">define categories that should be excluded</span>
(setq org-export-exclude-category (list <span style="color: #ffa07a;">"google"</span> <span style="color: #ffa07a;">"private"</span>))

<span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">define filter. The filter is called on each entry in the agenda.</span>
<span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">It defines a regexp to search for two timestamps, gets the start</span>
<span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">and end point of the entry and does a regexp search. It also</span>
<span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">checks if the category of the entry is in an exclude list and</span>
<span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">returns either t or nil to skip or include the entry.</span>

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">org-mycal-export-limit</span> ()
  <span style="color: #ffa07a;">"Limit the export to items that have a date, time and a range. Also exclude certain categories."</span>
  (setq org-tst-regexp <span style="color: #ffa07a;">"&lt;</span><span style="color: #ffa07a; font-weight: bold;">\\</span><span style="color: #ffa07a; font-weight: bold;">(</span><span style="color: #ffa07a;">[0-9]\\{4\\}-[0-9]\\{2\\}-[0-9]\\{2\\} ... [0-9]\\{2\\}:[0-9]\\{2\\}[</span><span style="color: #ffa07a;">^</span><span style="color: #ffa07a;">\r\n&gt;]*?\</span>
<span style="color: #ffa07a;">\)&gt;"</span>)
  (setq org-tstr-regexp (concat org-tst-regexp <span style="color: #ffa07a;">"--?-?"</span> org-tst-regexp))
  (<span style="color: #00ffff;">save-excursion</span>
    <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">get categories</span>
    (setq mycategory (org-get-category))
    <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">get start and end of tree</span>
    (org-back-to-heading t)
    (setq mystart    (point))
    (org-end-of-subtree)
    (setq myend      (point))
    (goto-char mystart)
    <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">search for timerange</span>
    (setq myresult (re-search-forward org-tstr-regexp myend t))
    <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">search for categories to exclude</span>
    (setq mycatp (member mycategory org-export-exclude-category))
    <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">return t if ok, nil when not ok</span>
    (<span style="color: #00ffff;">if</span> (and myresult (not mycatp)) t nil)))

<span style="color: #ff7f24;">;;; </span><span style="color: #ff7f24;">activate filter and call export function</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">org-mycal-export</span> ()
  (<span style="color: #00ffff;">let</span> ((org-icalendar-verify-function 'org-mycal-export-limit))
    (org-export-icalendar-combine-agenda-files)))
</pre>
</div>

<p>
To use these function you can include the above code in your .emacs
file and then in case you run Emacs server call
</p>

<div class="org-src-container">

<pre class="src src-sh">emacsclient -e <span style="color: #ffa07a;">"(save-excursion (org-mycal-export))"</span>
</pre>
</div>

<p>
in your shell to generate the .ics file.
</p>

<p>
If you want to export also TODO items that have a SCHEDULED timestamp, you can set
</p>

<div class="org-src-container">

<pre class="src src-sh">(setq org-icalendar-use-scheduled <span style="color: #ffa07a;">'(todo-start event-if-todo))</span>
</pre>
</div>

<p>
in your .emacs.
</p>

<p>
Another Emacs variable that you might want to look into is:
org-icalendar-honor-noexport-tag.
</p>

<p>
You can now automate this via a cron job to generate updated .ics
files.
</p>

<p>
The next step is to give the file a cryptic name (so that other
people have a hard time accessing your file, also make sure that
your web server doesn't show an index for your directory, etc.) and
copy it to a public accessible web server. Then log into your Google
calendar and in the left column under "Other calendars" use
"Add"-&gt;"Add by url" to point Google at your freshly generated .ics
file and you should be all set up. Once you done this Google will
every now and then (every few hours?) look for a newer version of your .ics file and
include this in your calendar.
</p>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Other methods of syncing</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1">org-caldav</h3>
<div class="outline-text-3" id="text-4-1">
<p>
David Engster writes:
</p>

<blockquote>
<p>
I have written a package 'org-caldav' which can sync items to a remote
calendar server using the CalDAV protocol. The main purpose of this
package is to make better use of Org in combination with Android-based
mobile devices (yes, there is mobileOrg, but I have several problems
with it; that's a topic for another day, though).
</p>

<p>
I think org-caldav is now "good enough" to allow some testing by
adventurous people. I put the code up on github here
</p>

<p>
<a href="https://github.com/dengste/org-caldav">https://github.com/dengste/org-caldav</a>
</p>
</blockquote>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup> <p class="footpara">
<a href="http://article.gmane.org/gmane.emacs.orgmode/26848">http://article.gmane.org/gmane.emacs.orgmode/26848</a>
</p></div>

<div class="footdef"><sup><a id="fn.2" name="fn.2" class="footnum" href="#fnr.2">2</a></sup> <p class="footpara">
<a href="http://article.gmane.org/gmane.emacs.orgmode/27214">http://article.gmane.org/gmane.emacs.orgmode/27214</a></p></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="date">Date: <span class="timestamp-wrapper"><span class="timestamp">&lt;2011-02-28 Mon&gt;</span></span></p>
<p class="author">Author: Arun Persaud</p>
<p class="date">Created: 2014-05-02 五 10:38</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.3 (<a href="http://orgmode.org">Org</a> mode 8.2.5h)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
